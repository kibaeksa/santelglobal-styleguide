/*
    init 방법
    Common : 데이타셋 data-modalpop 으로 정의 될 예정

    1. 자바스크립트 init 함수
    2. HTML 코딩 해놓고 스크립트 함수로 정의

    Options
    {
        name :type String , default undefined,
        key : default : modalpop_Date.now(),
        isRendered : false,
        element : typeof DOM (js에서 init 될때는 String),
        width, type String, default : innerWidth
        height, type String , default : auto
        valign, type String , default : center
        align, type String , default : center

        ===== 이하 속성은 javascript 에서 init 할때 사용 가능한 옵션 =====
        callback  type : function , default : false
        onload : type : function , default : false,
        handleClick : typeof function
        htmlString : { typeof Object , default : false
            title : '' typeof String
            contents : '' typeof String
        }
*/



(function($){

    var modalPopupContainer = modalPopupContainer || {};

    function setDataset(e,o){var t;for(t in o)e.dataset?e.dataset[t]=o[t]:e.setAttribute("data-"+t.replace(/[A-Z]/g,"-$&").toLowerCase(),o[t])}function getDataset(e,o){var t,a=o.replace(/[A-Z]/g,"-$&").toLowerCase();return void 0!==(t=e.dataset?e.dataset[o]:e.getAttribute("data-"+a))&&t}function setPopupName(e){return e.replace(/\-\w/g,function(e){return e.substring(1).toUpperCase()})}function initModal(){initModalpopByHtml(),initElement()}function getElementsByClassName(e){return $?$("."+e):document.getElementsByClassName(e)}function initModalpopByJs(e){var o={};o.name=e.name,o.width=e.width||"auto",o.height=e.height||"auto",o.align=e.align||"center",o.valign=e.valign||"center",o.autoOpen=e.autoOpen||!1,o.disableClose=e.disableClose||!1,o.onload=e.onload||!1,o.onopen=e.onopen||!1,o.onclose=e.onclose||!1,o.buttons=e.buttons||!1,o.htmlString=e.htmlString||{title:e.htmlString.title||"",contents:e.htmlString.contents||!1},createModalObject(o),generateHTML(o)}function initModalpopByHtml(){findModalElement("modal-popup-wrapper",function(e,o,t){var a=getDataset(e,"modalpop");if(!1!==(a=null!=a&&a)&&!getDataset(e,"modalpopInit")){var n=createModalObject(elementToJson(e));setDataset(e,{modalpopInit:!0,modalpopKey:n.key}),n.onload&&n.onload.call(window,n)}})}function bindDefaultEvent(e){modalPopupContainer[setPopupName(e)].disableClose||($(modalPopupContainer[setPopupName(e)].element).find(".popup-header .close").bind("click",function(){closePopup(e),modalPopupContainer[setPopupName(e)].onclose&&modalPopupContainer[setPopupName(e)].onclose.call(window,modalPopupContainer[setPopupName(e)])}),$(modalPopupContainer[setPopupName(e)].element).find(".overlay").bind("click",function(){closePopup(e),modalPopupContainer[setPopupName(e)].onclose&&modalPopupContainer[setPopupName(e)].onclose.call(window,modalPopupContainer[setPopupName(e)])}))}function findModalElement(e,o){for(var t=getElementsByClassName(e),a=0,n=0;a<t.length;a++)n++,attrs=t[a].attributes,null!=attrs&&(o.call(window,t[a],t[a].attributes),n++)}function createModalObject(e){var o=Date.now(),t={};return modalPopupContainer[setPopupName(e.name)]?($.extend(modalPopupContainer[setPopupName(e.name)],e),t=modalPopupContainer[setPopupName(e.name)]):((t=e).key=o,modalPopupContainer[setPopupName(t.name)]=t),t}function getObjectByKey(e){var o=0;for(o in modalPopupContainer)if(modalPopupContainer[setPopupName(o)].key==e||modalPopupContainer[setPopupName(o)].name==e)return modalPopupContainer[setPopupName(o)];return!1}function initElement(){var e,o;for(e in modalPopupContainer)modalPopupContainer[e].isSetDone||(modalPopupContainer[e].isSetDone=!0,(o=$(modalPopupContainer[setPopupName(e)].element)).find(".popup").css({width:modalPopupContainer[setPopupName(e)].width?modalPopupContainer[setPopupName(e)].width+"px":"auto",height:modalPopupContainer[setPopupName(e)].height?modalPopupContainer[setPopupName(e)].height+"px":"auto",margin:("auto"!=modalPopupContainer[setPopupName(e)].height&&"center"==modalPopupContainer[setPopupName(e)].valign?-modalPopupContainer[setPopupName(e)].height/2:"30")+"px 0px 0px "+("auto"!=modalPopupContainer[setPopupName(e)].width&&"center"==modalPopupContainer[setPopupName(e)].align?-modalPopupContainer[setPopupName(e)].width/2:"0")+"px",left:"center"==modalPopupContainer[setPopupName(e)].align?"50%":"0px",top:"center"==modalPopupContainer[setPopupName(e)].valign?"50%":"0px"}),modalPopupContainer[setPopupName(e)].fade&&(o.find(".popup").get(0).style.webkitTransition=o.find(".popup").get(0).style.transition=o.find(".popup").get(0).style.MozTransition="opacity 0.3s ease 0.1s",o.find(".overlay").get(0).style.webkitTransition=o.find(".overlay").get(0).style.transition=o.find(".overlay").get(0).style.MozTransition="opacity 0.3s",o.find(".popup").css({opacity:0}),o.find(".overlay").css({opacity:0})),bindDefaultEvent(e),modalPopupContainer[setPopupName(e)].autoOpen&&(openPopup(e),modalPopupContainer[setPopupName(e)].onopen&&modalPopupContainer[setPopupName(e)].onopen.call(window,modalPopupContainer[setPopupName(e)])))}function openPopup(e){if("auto"==modalPopupContainer[setPopupName(e)].height&&"center"==modalPopupContainer[setPopupName(e)].valign){var o=$(modalPopupContainer[setPopupName(e)].element).clone();o.css({opacity:0}).addClass("open"),$("body").append(o);var t=o.find(".popup").height();o.remove(),t>$(window).height()?$(modalPopupContainer[setPopupName(e)].element).find(".popup").css({top:0,marginTop:0}):$(modalPopupContainer[setPopupName(e)].element).find(".popup").css({top:"50%",marginTop:t/2*-1})}$(modalPopupContainer[setPopupName(e)].element).addClass("open"),modalPopupContainer[setPopupName(e)].fade&&setTimeout(function(){$(modalPopupContainer[setPopupName(e)].element).find(".popup").css({opacity:1}),$(modalPopupContainer[setPopupName(e)].element).find(".overlay").css({opacity:.7})},100)}function closePopup(e){modalPopupContainer[setPopupName(e)].fade?($(modalPopupContainer[setPopupName(e)].element).find(".popup").css({opacity:0}),$(modalPopupContainer[setPopupName(e)].element).find(".overlay").css({opacity:0}),setTimeout(function(){$(modalPopupContainer[setPopupName(e)].element).removeClass("open")},300)):$(modalPopupContainer[setPopupName(e)].element).removeClass("open")}function bindingOpenEvent(){findModalElement("modal-popup-click",function(e,o){if(getDataset(e,"modalpopClick")&&null!==e.getAttribute("data-modalpop-click")){var t=e.getAttribute("data-modalpop-click");void 0!=modalPopupContainer[setPopupName(t)]&&$(e).bind("click",function(){openPopup(t),modalPopupContainer[setPopupName(t)].onopen&&modalPopupContainer[setPopupName(t)].onopen.call(window,modalPopupContainer[setPopupName(t)])})}})}function checkModalPopup(e){var o;for(o in modalPopupContainer)if(o==setPopupName(e))return o;return!1}function rerender(){findModalElement("modal-popup-wrapper",function(e,o,t){var a=getDataset(e,"modalpop");!1!==(a=null!=a&&a)&&(getDataset(e,"modalpopInit")||checkModalPopup(getDataset(e,"modalpopName"))||setDataset(e,{modalpopInit:!0,modalpopKey:createModalObject(elementToJson(e)).key}))})}function generateHTML(e){var o='<div data-modalpop=""';if(o+=' class="modal-popup-wrapper cn_'+e.name+'"',o+=' data-modalpop-name="'+e.name+'"',o+=' data-modalpop-height="'+e.height+'"',o+=' data-modalpop-width="'+e.width+'"',e.autoOpen&&(o+=' data-modalpop-autoopen=""'),o+="   >",o+='     <div class="overlay"></div>',o+='     <div class="popup">',e.disableClose||(e.htmlString.title?o+='         <div class="popup-header"><h2>'+e.htmlString.title+'</h2><a href="javascript:void(0)" class="close"><span class="spt_bg"></span></a></div>':o+='         <div class="popup-header"><a href="javascript:void(0)" class="close" style="top:1px;right:1px;"><span class="spt_bg"></span></a></div>'),o+='         <div class="popup-contents">',o+=e.htmlString.contents,e.buttons){o+='<div class="confirm_button_area col'+e.buttons.length+'">';for(n=0;n<e.buttons.length;n++){if(o+='<div class="button_box dialog_button'+(n+1)+'">',o+="     <a",o+='         class="'+e.buttons[n].className.replace(/(^\s|\s$)/,"")+'"',o+='         href="'+(e.buttons[n].link?e.buttons[n].link:"javascript:void(0)")+'"',e.buttons[n].attrs)for(var t in e.buttons[n].attrs)o+="         "+t.replace(/[A-Z]/g,function(e){return"-"+e.toLowerCase()})+'="'+e.buttons[n].attrs[t]+'"';o+="     >",o+="         <span>"+e.buttons[n].text+"</span>",o+="     </a>",o+="</div>"}o+="</div>"}o+="</div>",o+="     </div>",o+="</div>";var a=document.createElement("div");if(a.innerHTML=o,document.getElementsByTagName("body")[0].appendChild(a.children[0]),e.buttons)for(var n=0;n<e.buttons.length;n++)e.buttons[n].callback&&function(e,o){$(".cn_"+o.name+" .dialog_button"+(n+1)).bind("click",function(t){e.call(window,t,o)})}(e.buttons[n].callback,e)}function elementToJson(e){return{name:getDataset(e,"modalpopName"),element:e,width:getDataset(e,"modalpopWidth")||"auto",height:getDataset(e,"modalpopHeight")||"auto",align:getDataset(e,"modalpopAlign")||"center",valign:getDataset(e,"modalpopValign")||"center",autoOpen:""===getDataset(e,"modalpopAutoopen"),fade:""===getDataset(e,"modalpopFade")}}


    /*
    API Structure

    Name : ModalPopup
    Fucntion :
        name : init
        description : Modalpopup 을 js object 데이터 기반으로 초기화해주는 함수
        @params
            Object : Modalpop 정보

        name : reinit
        description : Html에 비동기적으로 들어간 HTML이 있을 경우 다시 호출하여 재정의

        name : getObject
        description : 특정 key값을 가진 object 리턴
        @params
            String : key값

        name : setObject
        description : 특정 key값을 가진 object를 다시 정의
        @params
            String : key값,
            Object : 새로 변경 될 속성값


    Variable :
    */

    window.ModalPopup = {
        init : function(popupData){
            initModalpopByJs(popupData);
        },
        getPopupData : function(popName){
            if(popName == undefined){
                return modalPopupContainer;
            }else{
                return modalPopupContainer[setPopupName(popName)];
            }
        },
        openPopup : function(popName){
            openPopup(popName);
        },
        closePopup : function(popName){
            closePopup(popName);
        },
        rerender : function(){
            rerender();
        },
        bind : function(key , eventObj){
            if(!modalPopupContainer[setPopupName(key)]){
                modalPopupContainer[setPopupName(key)] = {};
            }

            var eventName;
            for(eventName in eventObj){
                modalPopupContainer[setPopupName(key)][eventName] = eventObj[eventName];
            }
        }
    };


    $(document).ready(function(){
        initModal();
        bindingOpenEvent();
    });

})(jQuery);
