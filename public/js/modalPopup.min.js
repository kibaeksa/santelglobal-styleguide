/*
    init 방법
    Common : 데이타셋 data-modalpop 으로 정의 될 예정

    1. 자바스크립트 init 함수
    2. HTML 코딩 해놓고 스크립트 함수로 정의

    Options
    {
        name :type String , default undefined,
        key : default : modalpop_Date.now(),
        isRendered : false,
        element : typeof DOM (js에서 init 될때는 String),
        width, type String, default : innerWidth
        height, type String , default : auto
        valign, type String , default : center
        align, type String , default : center

        ===== 이하 속성은 javascript 에서 init 할때 사용 가능한 옵션 =====
        callback  type : function , default : false
        onload : type : function , default : false,
        handleClick : typeof function
        htmlString : { typeof Object , default : false
            title : '' typeof String
            contents : '' typeof String
        }
*/



(function($){

    var modalPopupContainer = modalPopupContainer || {};
    var commonEvents = {};

    function setDataset(o,e){var t;for(t in e)o.dataset?o.dataset[t]=e[t]:o.setAttribute("data-"+t.replace(/[A-Z]/g,"-$&").toLowerCase(),e[t])}function getDataset(o,e){var t,a=e.replace(/[A-Z]/g,"-$&").toLowerCase();return void 0!==(t=o.dataset?o.dataset[e]:o.getAttribute("data-"+a))&&t}function setPopupName(o){return o.replace(/\-\w/g,function(o){return o.substring(1).toUpperCase()})}function initModal(){initModalpopByHtml(),initElement()}function getElementsByClassName(o){return $?$("."+o):document.getElementsByClassName(o)}function initModalpopByJs(o){var e={};e.name=o.name,e.width=o.width||"auto",e.height=o.height||"auto",e.align=o.align||"center",e.valign=o.valign||"center",e.autoOpen=o.autoOpen||!1,e.disableClose=o.disableClose||!1,e.onload=o.onload||!1,e.onopen=o.onopen||!1,e.onclose=o.onclose||!1,e.buttons=o.buttons||!1,e.htmlString=o.htmlString||{title:o.htmlString.title||"",contents:o.htmlString.contents||!1},createModalObject(e),generateHTML(e)}function initModalpopByHtml(){findModalElement("modal-popup-wrapper",function(o,e,t){var a=getDataset(o,"modalpop");if(!1!==(a=null!=a&&a)&&!getDataset(o,"modalpopInit")){var n=createModalObject(elementToJson(o));setDataset(o,{modalpopInit:!0,modalpopKey:n.key}),n.onload&&n.onload.call(window,n),commonEvents.onload&&commonEvents.onload.call(window,n)}})}function bindDefaultEvent(o){modalPopupContainer[setPopupName(o)].disableClose||($(modalPopupContainer[setPopupName(o)].element).find(".popup-header .close").bind("click",function(){closePopup(o),modalPopupContainer[setPopupName(o)].onclose&&modalPopupContainer[setPopupName(o)].onclose.call(window,modalPopupContainer[setPopupName(o)]),commonEvents.onclose&&commonEvents.onclose.call(window,modalPopupContainer[setPopupName(o)])}),$(modalPopupContainer[setPopupName(o)].element).find(".overlay").bind("click",function(){closePopup(o),modalPopupContainer[setPopupName(o)].onclose&&modalPopupContainer[setPopupName(o)].onclose.call(window,modalPopupContainer[setPopupName(o)]),commonEvents.onclose&&commonEvents.onclose.call(window,modalPopupContainer[setPopupName(o)])}))}function findModalElement(o,e){for(var t=getElementsByClassName(o),a=0,n=0;a<t.length;a++)n++,attrs=t[a].attributes,null!=attrs&&(e.call(window,t[a],t[a].attributes),n++)}function createModalObject(o){var e=Date.now(),t={};return modalPopupContainer[setPopupName(o.name)]?($.extend(modalPopupContainer[setPopupName(o.name)],o),t=modalPopupContainer[setPopupName(o.name)]):((t=o).key=e,modalPopupContainer[setPopupName(t.name)]=t),t}function getObjectByKey(o){var e=0;for(e in modalPopupContainer)if(modalPopupContainer[setPopupName(e)].key==o||modalPopupContainer[setPopupName(e)].name==o)return modalPopupContainer[setPopupName(e)];return!1}function initElement(){var o,e;for(o in modalPopupContainer)modalPopupContainer[o].isSetDone||(modalPopupContainer[o].isSetDone=!0,(e=$(modalPopupContainer[setPopupName(o)].element)).find(".popup").css({width:modalPopupContainer[setPopupName(o)].width?modalPopupContainer[setPopupName(o)].width+"px":"auto",height:modalPopupContainer[setPopupName(o)].height?modalPopupContainer[setPopupName(o)].height+"px":"auto",margin:("auto"!=modalPopupContainer[setPopupName(o)].height&&"center"==modalPopupContainer[setPopupName(o)].valign?-modalPopupContainer[setPopupName(o)].height/2:"30")+"px 0px 0px "+("auto"!=modalPopupContainer[setPopupName(o)].width&&"center"==modalPopupContainer[setPopupName(o)].align?-modalPopupContainer[setPopupName(o)].width/2:"0")+"px",left:"center"==modalPopupContainer[setPopupName(o)].align?"50%":"0px",top:"center"==modalPopupContainer[setPopupName(o)].valign?"50%":"0px"}),modalPopupContainer[setPopupName(o)].fade&&(e.find(".popup").get(0).style.webkitTransition=e.find(".popup").get(0).style.transition=e.find(".popup").get(0).style.MozTransition="opacity 0.3s ease 0.1s",e.find(".overlay").get(0).style.webkitTransition=e.find(".overlay").get(0).style.transition=e.find(".overlay").get(0).style.MozTransition="opacity 0.3s",e.find(".popup").css({opacity:0}),e.find(".overlay").css({opacity:0})),bindDefaultEvent(o),modalPopupContainer[setPopupName(o)].autoOpen&&(openPopup(o),modalPopupContainer[setPopupName(o)].onopen&&modalPopupContainer[setPopupName(o)].onopen.call(window,modalPopupContainer[setPopupName(o)]),commonEvents.onopen&&commonEvents.onopen.call(window,modalPopupContainer[setPopupName(o)])))}function openPopup(o){if("auto"==modalPopupContainer[setPopupName(o)].height&&"center"==modalPopupContainer[setPopupName(o)].valign){var e=$(modalPopupContainer[setPopupName(o)].element).clone();e.css({opacity:0}).addClass("open"),$("body").append(e);var t=e.find(".popup").height();e.remove(),t>$(window).height()?$(modalPopupContainer[setPopupName(o)].element).find(".popup").css({top:0,marginTop:0}):$(modalPopupContainer[setPopupName(o)].element).find(".popup").css({top:"50%",marginTop:t/2*-1})}$(modalPopupContainer[setPopupName(o)].element).addClass("open"),modalPopupContainer[setPopupName(o)].fade&&setTimeout(function(){$(modalPopupContainer[setPopupName(o)].element).find(".popup").css({opacity:1}),$(modalPopupContainer[setPopupName(o)].element).find(".overlay").css({opacity:.7})},100)}function closePopup(o){modalPopupContainer[setPopupName(o)].fade?($(modalPopupContainer[setPopupName(o)].element).find(".popup").css({opacity:0}),$(modalPopupContainer[setPopupName(o)].element).find(".overlay").css({opacity:0}),setTimeout(function(){$(modalPopupContainer[setPopupName(o)].element).removeClass("open")},300)):$(modalPopupContainer[setPopupName(o)].element).removeClass("open")}function bindingOpenEvent(){findModalElement("modal-popup-click",function(o,e){if(getDataset(o,"modalpopClick")&&null!==o.getAttribute("data-modalpop-click")){var t=o.getAttribute("data-modalpop-click");void 0!=modalPopupContainer[setPopupName(t)]&&$(o).bind("click",function(){openPopup(t),modalPopupContainer[setPopupName(t)].onopen&&modalPopupContainer[setPopupName(t)].onopen.call(window,modalPopupContainer[setPopupName(t)]),commonEvents.onopen&&commonEvents.onopen.call(window,modalPopupContainer[setPopupName(t)])})}})}function checkModalPopup(o){var e;for(e in modalPopupContainer)if(e==setPopupName(o))return e;return!1}function rerender(){findModalElement("modal-popup-wrapper",function(o,e,t){var a=getDataset(o,"modalpop");!1!==(a=null!=a&&a)&&(getDataset(o,"modalpopInit")||checkModalPopup(getDataset(o,"modalpopName"))||setDataset(o,{modalpopInit:!0,modalpopKey:createModalObject(elementToJson(o)).key}))})}function generateHTML(o){var e='<div data-modalpop=""';if(e+=' class="modal-popup-wrapper cn_'+o.name+'"',e+=' data-modalpop-name="'+o.name+'"',e+=' data-modalpop-height="'+o.height+'"',e+=' data-modalpop-width="'+o.width+'"',o.autoOpen&&(e+=' data-modalpop-autoopen=""'),e+="   >",e+='     <div class="overlay"></div>',e+='     <div class="popup">',o.disableClose||(o.htmlString.title?e+='         <div class="popup-header"><h2>'+o.htmlString.title+'</h2><a href="javascript:void(0)" class="close"><span class="spt_bg"></span></a></div>':e+='         <div class="popup-header"><a href="javascript:void(0)" class="close" style="top:1px;right:1px;"><span class="spt_bg"></span></a></div>'),e+='         <div class="popup-contents">',e+=o.htmlString.contents,o.buttons){e+='<div class="confirm_button_area col'+o.buttons.length+'">';for(n=0;n<o.buttons.length;n++){if(e+='<div class="button_box dialog_button'+(n+1)+'">',e+="     <a",e+='         class="'+o.buttons[n].className.replace(/(^\s|\s$)/,"")+'"',e+='         href="'+(o.buttons[n].link?o.buttons[n].link:"javascript:void(0)")+'"',o.buttons[n].attrs)for(var t in o.buttons[n].attrs)e+="         "+t.replace(/[A-Z]/g,function(o){return"-"+o.toLowerCase()})+'="'+o.buttons[n].attrs[t]+'"';e+="     >",e+="         <span>"+o.buttons[n].text+"</span>",e+="     </a>",e+="</div>"}e+="</div>"}e+="</div>",e+="     </div>",e+="</div>";var a=document.createElement("div");if(a.innerHTML=e,document.getElementsByTagName("body")[0].appendChild(a.children[0]),o.buttons)for(var n=0;n<o.buttons.length;n++)o.buttons[n].callback&&function(o,e){$(".cn_"+e.name+" .dialog_button"+(n+1)).bind("click",function(t){o.call(window,t,e)})}(o.buttons[n].callback,o)}function elementToJson(o){return{name:getDataset(o,"modalpopName"),element:o,width:getDataset(o,"modalpopWidth")||"auto",height:getDataset(o,"modalpopHeight")||"auto",align:getDataset(o,"modalpopAlign")||"center",valign:getDataset(o,"modalpopValign")||"center",autoOpen:""===getDataset(o,"modalpopAutoopen"),fade:""===getDataset(o,"modalpopFade")}}


    /*
    API Structure

    Name : ModalPopup
    Fucntion :
        name : init
        description : Modalpopup 을 js object 데이터 기반으로 초기화해주는 함수
        @params
            Object : Modalpop 정보

        name : reinit
        description : Html에 비동기적으로 들어간 HTML이 있을 경우 다시 호출하여 재정의

        name : getObject
        description : 특정 key값을 가진 object 리턴
        @params
            String : key값

        name : setObject
        description : 특정 key값을 가진 object를 다시 정의
        @params
            String : key값,
            Object : 새로 변경 될 속성값


    Variable :
    */

    window.ModalPopup = {
        init : function(popupData){
            initModalpopByJs(popupData);
        },
        getPopupData : function(popName){
            if(popName == undefined){
                return modalPopupContainer;
            }else{
                return modalPopupContainer[setPopupName(popName)];
            }
        },
        openPopup : function(popName){
            openPopup(popName);
        },
        closePopup : function(popName){
            closePopup(popName);

            if(!!modalPopupContainer[setPopupName(popName)].onclose){
                modalPopupContainer[setPopupName(popName)].onclose.call(window , modalPopupContainer[setPopupName(popName)]);
            }

            if(!!commonEvents.onclose){
                commonEvents.onclose.call(window , modalPopupContainer[setPopupName(popName)]);
            }

        },
        rerender : function(){
            rerender();
        },
        bind : function(key , eventObj){
            var eventName;

            if(typeof key === 'string'){
                if(!modalPopupContainer[setPopupName(key)]){
                    modalPopupContainer[setPopupName(key)] = {};
                }
                for(eventName in eventObj){
                    modalPopupContainer[setPopupName(key)][eventName] = eventObj[eventName];
                }
            }else{
                var eventObj_ = key;
                for(eventName in eventObj_){
                    commonEvents[eventName] = eventObj_[eventName];
                }
            }

        }
    };


    $(document).ready(function(){
        initModal();
        bindingOpenEvent();
    });

})(jQuery);
